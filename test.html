<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trusenda CRM Integration Test</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a73e8;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #5f6368;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1a73e8;
        }
        .test-section h3 {
            margin-top: 0;
            color: #202124;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #1557b0;
        }
        button.success {
            background: #28a745;
        }
        button.danger {
            background: #dc3545;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e8eaed;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .console-log {
            background: #202124;
            color: #e8eaed;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .console-log div {
            margin: 4px 0;
        }
        .log-info { color: #4a9eff; }
        .log-success { color: #28a745; }
        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ§ª Trusenda CRM Integration Test</h1>
        <p class="subtitle">Test your Palm Beach Warehouses â†’ Trusenda CRM connection</p>

        <div class="info-box">
            <strong>ðŸ“‹ What This Tests:</strong>
            <ul style="margin: 10px 0 0 20px;">
                <li>Connection to Trusenda API</li>
                <li>Tenant ID retrieval using slug: <code>zacharyvorsteg</code></li>
                <li>Lead submission to your CRM</li>
                <li>Error handling and validation</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>Test 1: Fetch Tenant ID</h3>
            <p>Verify that we can retrieve your Trusenda tenant ID</p>
            <button onclick="testFetchTenant()">Run Test</button>
            <span id="test1-status"></span>
        </div>

        <div class="test-section">
            <h3>Test 2: Submit Test Lead</h3>
            <p>Submit a test lead to your Trusenda CRM</p>
            <button onclick="testSubmitLead()">Submit Test Lead</button>
            <span id="test2-status"></span>
        </div>

        <div class="test-section">
            <h3>Test 3: Test Error Handling</h3>
            <p>Submit invalid data to test error handling</p>
            <button onclick="testErrorHandling()">Test Errors</button>
            <span id="test3-status"></span>
        </div>

        <div class="test-section">
            <h3>Test 4: View Live Form</h3>
            <p>Open the actual Palm Beach Warehouses landing page</p>
            <button class="success" onclick="window.open('index.html', '_blank')">Open Landing Page</button>
            <button class="success" onclick="window.open('https://trusenda.com', '_blank')">Open Trusenda CRM</button>
        </div>

        <div id="results"></div>
        
        <div class="console-log" id="console" style="display: none;">
            <strong>Console Logs:</strong>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://trusenda.com/.netlify/functions';
        const SLUG = 'zacharyvorsteg';
        let tenantId = null;

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const logs = document.getElementById('logs');
            console.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function showResults(data) {
            const results = document.getElementById('results');
            results.textContent = JSON.stringify(data, null, 2);
            results.style.display = 'block';
        }

        function setStatus(testId, status, message) {
            const statusEl = document.getElementById(`test${testId}-status`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        async function testFetchTenant() {
            log('ðŸš€ Starting Test 1: Fetch Tenant ID', 'info');
            setStatus(1, 'pending', 'Testing...');
            
            try {
                log(`ðŸ“¡ Fetching tenant info for slug: ${SLUG}`, 'info');
                
                const response = await fetch(`${API_URL}/get-public-form?slug=${SLUG}`);
                const data = await response.json();
                
                if (response.ok) {
                    tenantId = data.tenantId;
                    log(`âœ… Success! Tenant ID: ${tenantId}`, 'success');
                    setStatus(1, 'success', `âœ“ Success - Tenant ID: ${tenantId}`);
                    showResults(data);
                } else {
                    throw new Error(data.error || 'Failed to fetch tenant');
                }
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                setStatus(1, 'error', `âœ— Failed: ${error.message}`);
                showResults({ error: error.message });
            }
        }

        async function testSubmitLead() {
            log('ðŸš€ Starting Test 2: Submit Test Lead', 'info');
            setStatus(2, 'pending', 'Submitting...');
            
            // Fetch tenant ID first if not already fetched
            if (!tenantId) {
                log('âš ï¸ Tenant ID not available, fetching...', 'warning');
                await testFetchTenant();
                if (!tenantId) {
                    setStatus(2, 'error', 'âœ— Failed: No tenant ID');
                    return;
                }
            }
            
            const testData = {
                tenant_id: tenantId,
                name: 'Test Lead - ' + new Date().toLocaleTimeString(),
                email: 'test@palmbeachwarehouses.com',
                phone: '561-718-6725',
                budget: '$5,000 - $10,000',
                sizeMin: 5000,
                propertyType: 'Industrial',
                moveTiming: 'Immediate',
                preferredArea: 'Palm Beach County, FL',
                notes: 'This is a test lead from the integration test page.\n\nGenerated at: ' + new Date().toLocaleString(),
                source: 'palmbeachwarehouses.com (test)'
            };
            
            try {
                log('ðŸ“¦ Submitting test lead data...', 'info');
                
                const response = await fetch(`${API_URL}/ingest-lead`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (response.status === 201 || response.ok) {
                    log(`âœ… Success! Lead created with ID: ${result.id}`, 'success');
                    setStatus(2, 'success', `âœ“ Success - Lead ID: ${result.id}`);
                    showResults(result);
                    log('ðŸ“‹ Check your Trusenda CRM dashboard to see the test lead!', 'success');
                } else if (response.status === 402) {
                    log(`âš ï¸ Lead limit reached`, 'warning');
                    setStatus(2, 'error', 'âœ— Lead limit reached');
                    showResults(result);
                } else {
                    throw new Error(result.error || 'Failed to submit lead');
                }
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                setStatus(2, 'error', `âœ— Failed: ${error.message}`);
                showResults({ error: error.message });
            }
        }

        async function testErrorHandling() {
            log('ðŸš€ Starting Test 3: Error Handling', 'info');
            setStatus(3, 'pending', 'Testing...');
            
            try {
                log('ðŸ“¦ Submitting invalid lead data (missing required fields)...', 'info');
                
                const response = await fetch(`${API_URL}/ingest-lead`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId || 'invalid',
                        // Missing name field (required)
                        email: 'invalid-test@example.com'
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    log(`âœ… Error handling working correctly: ${result.error}`, 'success');
                    setStatus(3, 'success', `âœ“ Error handled: ${result.error}`);
                    showResults(result);
                } else {
                    log(`âš ï¸ Unexpected success - validation may not be working`, 'warning');
                    setStatus(3, 'error', 'âœ— Validation failed');
                    showResults(result);
                }
            } catch (error) {
                log(`âŒ Network error: ${error.message}`, 'error');
                setStatus(3, 'success', `âœ“ Error caught: ${error.message}`);
                showResults({ error: error.message });
            }
        }

        // Auto-run Test 1 on page load
        window.addEventListener('DOMContentLoaded', () => {
            log('ðŸŽ‰ Test page loaded successfully', 'success');
            log('ðŸ”§ API URL: ' + API_URL, 'info');
            log('ðŸ”‘ Slug: ' + SLUG, 'info');
            log('Click "Run Test" buttons to start testing', 'info');
        });
    </script>
</body>
</html>

